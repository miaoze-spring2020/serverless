version: 2.1
executors:
  deploy_executor:
    docker:
      - image: circleci/openjdk:8u171-jdk


jobs:
  codedeploy:
    executor: deploy_executor
    steps:
      - checkout
      - run:
          name: build artifact
          command: mvn package
      - run:
          name: move artifact and scripts appspec
          command: |
            mkdir ~/project/lambda_bundle
            mv ~/project/target/lambdaEmail.jar ~/project/lambda_bundle
            mv ~/project/appspec.yml ~/project/lambda_bundle
            mv ~/project/scripts ~/project/lambda_bundle
      - run:
          name: install aws
          command: |
            curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
            unzip awscli-bundle.zip
            sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
      - run:
          name: configure aws profile
          command: |
            aws configure set aws_access_key_id $AWS_ACCESS_KEY --profile circleci
            aws configure set aws_secret_access_key $AWS_SECRET_KEY --profile circleci
            aws configure set region $AWS_REGION --profile circleci
            aws configure set output json --profile circleci
      - run:
          name: upload to s3
          command: aws deploy push --application-name $CODEDEPLOY_APPNAME --s3-location s3://$CODEDEPLOY_BUCKETNAME/$BUCKET_KEYNAME --source ~/project/bundle --profile circleci
      - run:
          name: create deploy
          command: aws deploy create-deployment --application-name $CODEDEPLOY_APPNAME --s3-location bucket=$CODEDEPLOY_BUCKETNAME,bundleType=zip,key=$BUCKET_KEYNAME --deployment-group-name $CODEDEPLOY_GROUPNAME --description "cicd deploy" --profile circleci --debug

workflows:
  build-workflow:
    jobs:
      - codedeploy
            
